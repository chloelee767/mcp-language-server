# All-in-one Dockerfile for MCP Language Server Integration Tests
# Includes all language servers: gopls, pyright, rust-analyzer, typescript-language-server, and clangd

FROM golang:1.24-bookworm

WORKDIR /workspace

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    clang-16 \
    llvm-16 \
    clangd-16 \
    bear \
    make \
    python3.10 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
ENV PATH="/root/.cargo/bin:${PATH}"

# Install language servers
RUN go install golang.org/x/tools/gopls@latest && \
    npm install -g pyright typescript typescript-language-server && \
    rustup component add rust-src rust-analyzer

# Create symlink for clangd
RUN ln -s /usr/bin/clangd-16 /usr/bin/clangd

# Copy go module files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Build the mcp-language-server binary
RUN go build -o mcp-language-server

# Verify all language servers are installed
RUN echo "=== Verifying language server installations ===" && \
    gopls version && \
    pyright --version && \
    rustc --version && rust-analyzer --version && \
    npx typescript --version && npx typescript-language-server --version && \
    clangd-16 --version

# Generate compile commands for the clangd workspace
RUN cd integrationtests/workspaces/clangd && bear -- make

# Run all integration tests by default
CMD ["go", "test", "-v", "./integrationtests/tests/..."]
